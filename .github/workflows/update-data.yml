name: Update ETF Data

on:
  schedule:
    # Run at 7:30 AM ET (11:30 UTC) on weekdays — before US market open
    - cron: '30 11 * * 1-5'
    # Also run at 5:00 PM ET (21:00 UTC) on weekdays — after market close
    - cron: '0 21 * * 1-5'
  workflow_dispatch:  # allow manual trigger from GitHub UI

jobs:
  import-all-etfs:
    name: Import Full ETF Universe (~3400 ETFs)
    runs-on: ubuntu-latest
    # Only runs when manually triggered — not on schedule
    if: github.event_name == 'workflow_dispatch'
    env:
      NEXT_PUBLIC_SUPABASE_URL:  ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY:      ${{ secrets.SUPABASE_SERVICE_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Import all US ETFs from SEC EDGAR + Yahoo Finance
        run: node scripts/import-all-etfs.mjs

  update-aum:
    name: Refresh AUM & Prices
    runs-on: ubuntu-latest
    # Only run on schedule — not when manually triggering the import
    if: github.event_name == 'schedule'
    env:
      NEXT_PUBLIC_SUPABASE_URL:       ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY:  ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_KEY:           ${{ secrets.SUPABASE_SERVICE_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Fetch latest AUM from Yahoo Finance and upsert to Supabase
        run: node scripts/update-aum.mjs

  update-holdings:
    name: Refresh NPORT Holdings
    runs-on: ubuntu-latest
    # Only on schedule, and only on the morning run (not the evening one)
    if: github.event_name == 'schedule' && github.event.schedule == '30 11 * * 1-5'
    env:
      NEXT_PUBLIC_SUPABASE_URL:       ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY:  ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_KEY:           ${{ secrets.SUPABASE_SERVICE_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Fetch top holdings from SEC EDGAR NPORT-P
        run: node scripts/update-holdings.mjs

  revalidate-cache:
    name: Revalidate Vercel Cache
    runs-on: ubuntu-latest
    needs: [update-aum]
    if: github.event_name == 'schedule' && vars.VERCEL_REVALIDATE_TOKEN != ''
    steps:
      - name: Trigger Next.js on-demand revalidation
        run: |
          curl -X POST "${{ vars.VERCEL_APP_URL }}/api/revalidate?secret=${{ secrets.VERCEL_REVALIDATE_TOKEN }}" \
            -H "Content-Type: application/json" \
            --fail --silent --show-error
        continue-on-error: true
