name: Update ETF Data

on:
  schedule:
    # Run at 7:30 AM ET (11:30 UTC) on weekdays — before US market open
    - cron: '30 11 * * 1-5'
    # Also run at 5:00 PM ET (21:00 UTC) on weekdays — after market close
    - cron: '0 21 * * 1-5'
  workflow_dispatch:
    inputs:
      job:
        description: 'Which job to run'
        required: false
        default: 'refresh-prices'
        type: choice
        options:
          - refresh-prices   # call Vercel endpoint (recommended — works reliably)
          - import-etfs      # seed ETF registry from SEC EDGAR (one-time setup)

jobs:
  # ── Seed / re-import ETF registry from SEC EDGAR ────────────────────────────
  # Run manually only. Needs no external API access — pure EDGAR data.
  import-all-etfs:
    name: Import ETF Registry (EDGAR)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.job == 'import-etfs'
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY:     ${{ secrets.SUPABASE_SERVICE_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - run: npm ci
      - name: Seed ETF registry from SEC EDGAR
        run: node scripts/import-all-etfs.mjs

  # ── Refresh prices + AUM via Vercel endpoint ─────────────────────────────────
  # Runs on schedule (twice daily) and on manual dispatch.
  # The Vercel endpoint fetches from Yahoo Finance server-side — Vercel's IPs are
  # not blocked, unlike GitHub Actions runners whose IPs Yahoo Finance sometimes
  # rejects or rate-limits aggressively.
  refresh-prices:
    name: Refresh Prices via Vercel
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.job == 'refresh-prices')
    steps:
      - name: Trigger price refresh on Vercel
        run: |
          HTTP=$(curl -sL -o /tmp/resp.json -w "%{http_code}" \
            -X POST "${{ vars.VERCEL_APP_URL }}/api/cron/refresh-prices" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 90)
          echo "HTTP $HTTP"
          cat /tmp/resp.json
          if [ "$HTTP" != "200" ]; then exit 1; fi

  # ── Refresh NPORT holdings ────────────────────────────────────────────────────
  # Morning run only — holdings change less frequently than prices.
  update-holdings:
    name: Refresh NPORT Holdings
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '30 11 * * 1-5'
    env:
      NEXT_PUBLIC_SUPABASE_URL:      ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_KEY:          ${{ secrets.SUPABASE_SERVICE_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - run: npm ci
      - name: Fetch top holdings from SEC EDGAR NPORT-P
        run: node scripts/update-holdings.mjs
